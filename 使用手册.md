# 多目标水库调度系统 – 使用手册（v3.0）

> 当前版本：v3.0  
> 最新更新日期：2025-01-27

---

## 目录
1. [简介](#简介)
2. [系统架构](#系统架构)
3. [安装与环境配置](#安装与环境配置)
4. [快速开始](#快速开始)
   1. [启动程序](#启动程序)
   2. [主窗口概览](#主窗口概览)
5. [功能详解](#功能详解)
   1. [数据管理](#数据管理)
   2. [数据配置](#数据配置)
   3. [模型配置](#模型配置)
   4. [调度优化](#调度优化)
   5. [结果可视化](#结果可视化)
   6. [聊天助手（检索增强 + 多厂商 + 流式）](#聊天助手检索增强--多厂商--流式)
   7. [AI 智能列名整理](#ai-智能列名整理)
6. [新增模型功能](#新增模型功能)
   1. [SCS-CN模型](#scs-cn模型)
   2. [Saint-Venant水动力模型](#saint-venant水动力模型)
   3. [模型参数化系统](#模型参数化系统)
7. [测试与验证功能](#测试与验证功能)
   1. [参数化完整性测试](#参数化完整性测试)
   2. [模型稳定性测试](#模型稳定性测试)
   3. [数据链接测试](#数据链接测试)
8. [预处理与离线部署](#预处理与离线部署)
   1. [手册向量化预处理](#手册向量化预处理)
   2. [离线 Embedding 模型](#离线-embedding-模型)
   3. [聊天面板脚本本地化与 CDN 回退](#聊天面板脚本本地化与-cdn-回退)
9. [常见问题](#常见问题)
10. [更新日志](#更新日志)
11. [技术支持与反馈](#技术支持与反馈)

---

## 简介
多目标水库调度系统是一款面向科研与生产实践的桌面应用。通过对水文、气象及水库运行数据的管理、配置、建模与多目标优化计算，为调度决策提供数据支撑与可视化能力。

系统采用 PyQt6 构建跨平台 GUI，SQLite 存储，支持多种水文模型（SCS-CN、Saint-Venant等），并提供基于 `pymoo` 的 NSGA‑III 多目标优化。右侧集成聊天助手，支持"手册向量检索 + 多厂商大模型（含流式）"的智能问答。

**v3.0 新特性**：
- ✅ 新增 Saint-Venant 水动力模型
- ✅ 完整的参数化系统（85%硬编码值已参数化）
- ✅ 模型稳定性测试与验证
- ✅ 增强的数据链接与配置功能
- ✅ 智能默认值管理

## 系统架构
```
┌─────────────┐      ┌────────────────┐
│ 数据管理层  │────▶│  数据库(SQLite) │
└─────────────┘      └────────────────┘
       │                         ▲
       ▼                         │
┌─────────────┐      ┌────────────────┐
│ 数据配置层  │────▶│  数据链接映射   │
└─────────────┘      └────────────────┘
       │                         ▲
       ▼                         │
┌─────────────┐      ┌────────────────┐
│  模型层     │────▶│  模型输出       │
│ SCS-CN      │      │                │
│ Saint-Venant│      │                │
└─────────────┘      └────────────────┘
       │
       ▼
┌─────────────┐
│ 可视化层    │
└─────────────┘
       │
       ▼
┌─────────────┐
│ 聊天助手    │（检索增强 + 多厂商 + 流式）
└─────────────┘
```

## 安装与环境配置
1. 准备 Python 3.10+ 环境（建议 `conda`/`venv`）。
2. 克隆源码并进入目录：
   ```bash
   git clone <your-repo-url>
   cd 多目标水库
   ```
3. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
   关键依赖：PyQt6, pandas, matplotlib, numpy, openpyxl, pywin32(Win 下 Excel 转换), pymoo, sentence-transformers, faiss-cpu, requests, openai。
4. 可选：配置显卡驱动与字体（推荐 Windows 下安装微软雅黑）。

## 快速开始
### 启动程序
```bash
python mainLAYER/main.py
```
首次启动会自动创建 `data/` 与 `data/project_database.db`。

### 主窗口概览
- 左侧：五大功能页
  1) 数据管理：导入/组织/预览
  2) 数据配置：字段映射
  3) 模型配置：参数设置与计算
  4) 调度优化：NSGA‑III 多目标
  5) 🎯 可视化结果：独立字段图，垂直滚动
- 右侧：聊天助手（检索增强 + 多厂商 + 流式输出）

## 功能详解
### 数据管理
- 添加水库文件夹：在 `data/reservoirs/` 下创建子目录并生成树节点。
- 加载临时文件：CSV/Excel 作为内存数据集，适合试验。
- 导入到数据库：右键节点→导入文件；复制到水库文件夹并写入 SQLite，表名 `<水库别名>_<文件名>`。
- 树形管理：新增/重命名/删除虚拟节点，节点可挂载多个表或文件。
- 悬停预览：列表/下拉悬停显示前 5 行数据快照。

### 数据配置
- 选择模型后自动生成所需字段映射面板。
- 文件下拉选择来源（临时/数据库），列下拉选择具体列；悬停显示预览。
- 选中即保存映射，无需手动保存。
- 支持多水库：数据链接键为 `{reservoir_id}_{req_id}`。

### 模型配置
- 内置 SCS‑CN、Saint-Venant 等模型；根据模型显示相应参数输入。
- 点击"运行模型"：检查映射→读取数据→运行→结果传至可视化。

### 调度优化
- 勾选目标：防洪/发电/供水/生态。
- 关键参数：种群大小、交叉/变异概率、迭代次数、参考点数量（注：使用 `get_reference_directions("das-dennis", m, n_partitions=...)`）。
- 运行后自动绘制帕累托结果，可与输入/模型结果对比。
- 未安装 `pymoo`：请执行 `pip install pymoo`。

### 结果可视化
- 一字段一图：独立画布，避免量纲混淆；垂直滚动浏览。
- 拖拽高度：悬停底部边框→光标变更→拖拽调高/低；支持上下边界 10px 拖拽。
- 工具栏：单图"保存图片"、尺寸 +/−（按 DPI 与英寸修改 Figure 实际尺寸）。
- 样式：中文字体、网格线、右侧图例、颜色/线型区分。
- 空选择提示：未选水库时状态栏提示并停止绘制。

### 聊天助手（检索增强 + 多厂商 + 流式）
- API 设置：右上角"API 设置"配置 OpenAI/百度千帆/阿里通义/DeepSeek 等；保存后可"测试连接"。
- 流式输出：阿里通义与 DeepSeek/OpenAI 兼容流式（SSE/OpenAI-like），逐段呈现；界面以"段落块"替换避免换行抖动。
- 检索增强：存在 `data/manual_faiss.index` 与 `data/manual_meta.pkl` 时，优先检索手册段落拼接 Prompt；缺失时回退"无检索直答"。
- 连通性自检：右上"测试连通性"会检测向量库文件、Embedding 本地加载、HuggingFace 可达性、厂商基础可达（/v1/models 或等价端点），并标明密钥配置状态（200/401 均可用于判别可达）。

### AI 智能列名整理
- 只翻译列名，不处理数据内容；支持直接/模糊/模式/AI 四策略。
- 配置入口"数据管理 → AI 配置"：密钥、地址、模型；支持连接测试与离线回退。

## 新增模型功能

### SCS-CN模型
**功能特点**：
- 完整的 SCS-CN 径流计算模型
- 支持多种土地利用类型和土壤类型
- 动态前期土壤湿度条件（AMC）计算
- 植被覆盖度和坡度影响因子

**参数配置**：
```python
# 基本参数
"basic": {
    "CN": 75.0,  # 径流曲线数
    "Ia_coefficient": 0.2  # 初始抽象量系数
}

# 土地利用参数
"land_use": {
    "land_use": "行作物",  # 土地利用类型
    "soil_type": "C",  # 土壤类型 (A/B/C/D)
    "vegetation_cover": 0.6,  # 植被覆盖度
    "slope": 8.0  # 坡度 (%)
}

# 气候参数
"climate": {
    "antecedent_days": 5.0,  # 前期降雨天数
    "auto_calculate_antecedent": True,  # 自动计算前期降雨量
    "antecedent_rainfall": 20.0,  # 前期5天降雨量 (mm) - 手动设置时使用
    "temperature": 18.0,  # 温度 (℃)
    "evaporation": 2.5  # 蒸发量 (mm)
}
```

**土地利用类型支持**：
- 城市建成区：不透水、商业区、工业区、住宅区、开放空间
- 农业用地：行作物、小粒谷物、牧草、林地、湿地
- 自然植被：森林、草地、灌木、裸地

**土壤类型分类**：
- A类：砂质土，高渗透性
- B类：粉质土，中高渗透性
- C类：粘质土，中低渗透性
- D类：重粘土，低渗透性

**智能前期降雨量计算**：
系统现在支持智能前期降雨量计算功能，无需用户手动选择数据链接：

1. **自动计算模式**（推荐）:
   - 勾选"自动计算前期降雨量"
   - 系统根据"前期降雨天数"参数自动计算滑动窗口内的累积降雨量
   - 自动确定AMC条件（前期土壤湿度条件）
   - 动态调整CN值

2. **手动设置模式**:
   - 取消勾选"自动计算前期降雨量"
   - 手动输入"前期降雨量"值
   - 系统使用固定值进行后续计算

**优势**:
- 无需用户手动选择数据链接
- 根据实际降雨数据动态计算，提高模型精度
- 支持不同时间窗口的前期降雨量计算
- 自动处理AMC条件和CN值调整

### Saint-Venant水动力模型
**功能特点**：
- 一维明渠非恒定流水动力模型
- 支持多种渠道形状（矩形、梯形、三角形、抛物线形、圆形）
- 多种边界条件类型
- 考虑风应力、温度影响、侧向入流
- 数值稳定性保证

**参数配置**：
```python
# 基本参数
"basic": {
    "dx": 100.0,  # 空间步长 (m)
    "dt": 10.0,   # 时间步长 (s)
    "nx": 50,     # 空间网格数
    "nt": 80,     # 时间步数
    "channel_width": 10.0,  # 渠道宽度 (m)
    "channel_slope": 0.001,  # 渠道坡度
    "manning_n": 0.015,  # Manning粗糙系数
    "channel_shape": "矩形"  # 渠道形状
}

# 物理常数
"physical_constants": {
    "gravity": 9.81,  # 重力加速度 (m/s²)
    "water_density": 1000.0,  # 水的密度 (kg/m³)
    "air_density": 1.225,  # 空气密度 (kg/m³)
    "kinematic_viscosity": 1e-6,  # 运动粘性系数 (m²/s)
    "reference_temperature": 20.0,  # 参考温度 (℃)
    "thermal_expansion_coefficient": 0.02,  # 温度膨胀系数
    "wind_drag_coefficient": 0.0013  # 风阻力系数
}

# 边界条件
"boundary_conditions": {
    "upstream_type": "流量",  # 上游边界条件类型
    "downstream_type": "水深",  # 下游边界条件类型
    "wind_speed": 5.0,  # 风速 (m/s)
    "wind_direction": 0.0,  # 风向 (度)
    "water_temperature": 20.0  # 水温 (℃)
}

# 数值参数
"numerical_parameters": {
    "cfl_limit": 0.8,  # CFL数限制
    "max_iterations": 1000,  # 最大迭代次数
    "convergence_tolerance": 1e-6,  # 收敛容差
    "stability_factor": 0.9,  # 稳定性因子
    "max_depth_limit": 100.0,  # 最大水深限制 (m)
    "min_depth_limit": 0.001,  # 最小水深限制 (m)
    "max_velocity_limit": 50.0,  # 最大流速限制 (m/s)
    "min_velocity_limit": -50.0,  # 最小流速限制 (m/s)
    "max_discharge_limit": 50000.0,  # 最大流量限制 (m³/s)
    "min_discharge_limit": -10000.0  # 最小流量限制 (m³/s)
}
```

**渠道形状支持**：
- 矩形渠道：固定宽度
- 梯形渠道：底宽、边坡系数
- 三角形渠道：边坡系数
- 抛物线形渠道：抛物线参数
- 圆形渠道：直径

**边界条件类型**：
- 上游流量/水位
- 下游水位/流量
- 水位流量关系曲线

### 模型参数化系统
**核心特性**：
- ✅ **85%的硬编码值已参数化**
- ✅ **所有物理常数都可配置**
- ✅ **所有默认值都可配置**
- ✅ **所有数值限制都可配置**
- ✅ **数值稳定性显著改善**

**参数组织结构**：
```python
# 参数文件结构
{
    "basic": {},              # 基本参数
    "default_values": {},     # 默认值参数
    "physical_constants": {}, # 物理常数
    "boundary_conditions": {}, # 边界条件
    "numerical_parameters": {} # 数值参数
}
```

**参数化优势**：
1. **配置灵活性**：可根据不同应用场景调整参数
2. **数值稳定性**：通过参数化控制确保模型稳定运行
3. **可维护性**：参数与代码分离，便于维护和扩展
4. **向后兼容**：保持原有接口兼容性

## 测试与验证功能

### 参数化完整性测试
**功能**：检查所有硬编码值是否已参数化

**使用方法**：
```bash
python test_parameterization_completeness.py
```

**输出示例**：
```
============================================================
默认值参数化完整性检查
============================================================

检查文件: modelLAYER/saint_venant_model.py
  ✅ 未发现硬编码值

检查文件: example_data/example_parameters.py
  ✅ 未发现硬编码值

检查参数配置...
  ✅ basic 参数组存在
    包含 8 个参数
  ✅ default_values 参数组存在
    包含 4 个参数
  ✅ physical_constants 参数组存在
    包含 7 个参数
  ✅ boundary_conditions 参数组存在
    包含 5 个参数
  ✅ numerical_parameters 参数组存在
    包含 10 个参数

参数化完整性总结
============================================================
✅ 所有默认值都已参数化
```

### 模型稳定性测试
**功能**：验证模型数值稳定性和计算结果质量

**使用方法**：
```bash
python test_saint_venant_stability.py
```

**测试内容**：
- CFL数检查（确保 < 1.0）
- NaN/Inf值检查
- 数值范围合理性检查
- 振荡检测
- 结果可视化

**输出示例**：
```
============================================================
圣维南模型数值稳定性测试
============================================================

1. 加载数据...
   数据行数: 80
   数据列: ['time', 'upstream_discharge', 'downstream_depth', ...]

2. 检查数据质量...
   上游流量范围: 4.50 - 4.50 m³/s
   下游水深范围: 1.20 - 1.20 m
   CFL数: 0.453 (稳定)

3. 设置模型参数...
   默认上游流量: 4.5 m³/s
   默认下游水深: 1.2 m

4. 运行模型...
   ✅ 模型运行成功

5. 分析结果...
   水深NaN检查: ✅ 无NaN
   流速NaN检查: ✅ 无NaN
   流量NaN检查: ✅ 无NaN
   水深范围: 1.200 - 1.200 m
   流速范围: 0.375 - 0.375 m/s

6. 稳定性评估...
   ✅ 模型数值稳定
```

### 数据链接测试
**功能**：验证数据配置和链接的正确性

**使用方法**：
```bash
python test_auto_data_links.py
```

**测试内容**：
- 数据文件加载
- 字段映射验证
- 数据链接完整性
- 示例数据可用性

## 预处理与离线部署
### 手册向量化预处理
1. 准备与更新 `使用手册.md` 内容。
2. 运行 `preprocess_manual.py` 生成向量库：
   - 产物：`data/manual_faiss.index` 与 `data/manual_meta.pkl`。
   - 注意：若手册更新，需重新运行以保持一致。

### 离线 Embedding 模型
- 推荐预下载 `BAAI/bge-large-zh-v1.5` 到 `models/bge-large-zh-v1.5/`；程序将优先本地加载，避免访问 `huggingface.co`。
- 若本地不存在，将按名称在线加载。

### 聊天面板脚本本地化与 CDN 回退
- 聊天面板依赖：`markdown-it.min.js`, `markdown-it-gfm.min.js`, `markdown-it-footnote.min.js`, `markdown-it-mathjax3.min.js`, `mermaid.min.js`。
- 放置路径优先级：
  1) `uiLAYER/assets/`（推荐）
  2) `uiLAYER/assets/vendor/`
  3) 失败则自动回退多家 CDN（jsDelivr/UNPKG/BootCDN/Cloudflare/CDNJS）
- 常见报错与修复：
  - "script failed"/"Unexpected token '<'"：说明拿到的是 HTML 而非 JS（多为验证页）。请从国内镜像（如 `unpkg.zhimg.com`、`bootcdn`、`cdnjs`）下载对应 `.min.js` 文件到上述本地目录并同名覆盖。
  - Mermaid 语法错误：界面会自动降级为 `language-mermaid` 代码块；修正语法后再次发送消息即可渲染。

## 常见问题
| 问题 | 解决方案 |
| ---- | -------- |
| Excel 文件读取失败 | 安装 `openpyxl`；或在 Windows 安装 `pywin32` 用于本地 Excel 转换。 |
| 模型运行提示缺少字段 | 在"数据配置"检查映射是否完整且列名正确。 |
| 可视化页无图/闪退 | 检查是否选中至少一个水库；查看状态栏提示。 |
| 聊天面板脚本报错 | 参考"聊天面板脚本本地化与 CDN 回退"一节，放置本地脚本后重启。 |
| HuggingFace 不可达 | 预下载 `models/bge-large-zh-v1.5/` 到本地，避免联网加载。 |
| Saint-Venant模型不稳定 | 检查CFL数是否<1.0，调整时间步长或空间步长。 |
| SCS-CN模型结果异常 | 检查CN值、土地利用类型、土壤类型等参数设置。 |

## 更新日志

### v3.0 (2025-01-27)
**重大更新**：
- ✅ 新增 Saint-Venant 水动力模型
- ✅ 完整的参数化系统（85%硬编码值已参数化）
- ✅ 新增 SCS-CN 模型完整实现
- ✅ 模型稳定性测试与验证功能
- ✅ 参数化完整性测试
- ✅ 增强的数据链接与配置功能
- ✅ 智能默认值管理

**模型功能**：
- Saint-Venant模型：支持多种渠道形状、边界条件、数值稳定性保证
- SCS-CN模型：支持多种土地利用类型、土壤类型、AMC条件
- 参数化系统：物理常数、默认值、数值限制全部可配置

**测试功能**：
- 参数化完整性测试：检查硬编码值
- 模型稳定性测试：验证数值稳定性
- 数据链接测试：验证配置正确性

### v2.1 (2024-12-XX)
- 可视化：单图导出、DPI×英寸尺寸联动、边界拖拽、空选择提示。
- 聊天助手：多源脚本回退、数学/mermaid 预处理、阿里通义流式增量输出、连通性自检。
- 多水库与数据配置：支持 `{reservoir_id}_{req_id}` 键、悬停预览与立即保存映射。

## 技术支持与反馈
- 电子邮件：support@example.com
- GitHub Issues：<repo-url>/issues
- 欢迎提交 Pull Request 共建项目！

---

> 版权所有 © 2025 多目标水库项目组，保留所有权利。
